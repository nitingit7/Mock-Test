<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Test</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/config.js"></script>
    <script type="module">
        import { inject } from 'https://cdn.jsdelivr.net/npm/@vercel/analytics/+esm';
        inject();
    </script>
    <script>
        import { injectSpeedInsights } from 'https://cdn.jsdelivr.net/npm/@vercel/speed-insights/+esm';
        injectSpeedInsights();
    </script>
</head>

<body>
    <div class="container list-view-container">

        <div class="list-header-wrapper">
            <div class="text-area">
                <h2 id="list-title">Select Test</h2>
                <p class="list-subtitle">Choose a test to start practicing</p>
            </div>

            <div style="position: relative;">
                <button id="btn-filter-toggle" class="btn-filter" onclick="toggleFilterMenu()">
                    <span>üîç</span>
                </button>
                <div id="filter-dropdown" class="filter-dropdown">
                    <div
                        style="padding: 10px; border-bottom: 1px solid var(--border-color); font-weight: bold; font-size: 0.9rem;">
                        Filter by Name
                        <span style="float: right; cursor: pointer;" onclick="toggleFilterMenu()">‚úñ</span>
                    </div>
                    <div id="filter-options-list" class="filter-list"></div>
                    <button class="btn-clear-filter" onclick="clearFilter()">
                        Clear Filter
                    </button>
                </div>
            </div>
        </div>

        <div id="test-container" class="test-list-grid"></div>

        <div id="no-result-msg"
            style="display:none; color: var(--text-secondary); margin-top: 20px; text-align:center;">
            No tests found matching your filter.
        </div>
    </div>

    <script>
        // Theme Logic
        var savedTheme = localStorage.getItem('site-theme');
        if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); }

        var currentFilter = null;
        var loadedFiles = []; // Store files globally to access tags

        window.onload = function () {
            // 1. Back Button Logic
            history.pushState(null, null, location.href);
            window.onpopstate = function () { window.location.href = "index.html"; };

            // 2. Load Subject
            var params = new URLSearchParams(window.location.search);
            var subject = params.get('subject');

            if (subject) localStorage.setItem('last_subject_viewed', subject);

            if (!subject || !GITHUB_FILES[subject]) {
                alert("Invalid Subject"); location.href = 'index.html'; return;
            }

            document.getElementById('list-title').innerText = subject.toUpperCase().replace(/_/g, ' ');

            var list = document.getElementById('test-container');
            loadedFiles = GITHUB_FILES[subject]; // Save data to generate filters later

            // 3. Render Cards
            loadedFiles.forEach(function (f) {
                var div = document.createElement('div');
                div.className = 'test-card-modern';

                // IMPORTANT: Store the tag in a data attribute for filtering
                // If no tag exists, default to "General"
                var tag = f.tags ? f.tags.toLowerCase() : "general";
                div.setAttribute('data-tag', tag);
                div.setAttribute('data-name', f.name.toLowerCase()); // Keep name search too if needed

                // Icon Logic
                var icon = "üìù";
                if (f.name.toLowerCase().includes("speed")) icon = "‚ö°";
                if (f.name.toLowerCase().includes("puzzle")) icon = "üß©";
                if (f.name.toLowerCase().includes("full mock")) icon = "üèÜ";
                if (f.name.toLowerCase().includes("current affairs") || (f.tags && f.tags.includes("Daily"))) icon = "üìÖ";
                if (f.tags && f.tags.includes("Banking")) icon = "üè¶";
                if (f.tags && f.tags.includes("Static")) icon = "üóø";

                // Check for both completed result AND in-progress test
                var savedResult = localStorage.getItem(f.file);
                var savedProgress = localStorage.getItem(f.file + '_progress');

                var btnText, btnClass, statusText, statusColor;

                if (savedResult) {
                    // Test completed - show Analysis button
                    btnText = "Analysis";
                    btnClass = "btn-action btn-result";
                    statusText = "Completed";
                    statusColor = "var(--green)";
                } else if (savedProgress) {
                    // Test in progress - show Resume button
                    btnText = "Resume";
                    btnClass = "btn-action btn-resume";
                    statusText = "In Progress";
                    statusColor = "var(--blue)";
                } else {
                    // Not attempted - show Start button
                    btnText = "Start";
                    btnClass = "btn-action btn-list-start";
                    statusText = "Not Attempted";
                    statusColor = "var(--text-secondary)";
                }


                // Build metadata string if available
                var metadataHTML = '';
                if (f.questions || f.time || f.marks) {
                    var metaParts = [];
                    if (f.questions) metaParts.push(`üìù ${f.questions} Qs`);
                    if (f.time) metaParts.push(`‚è± ${f.time} min`);
                    if (f.marks) metaParts.push(`üéØ ${f.marks} marks`);
                    metadataHTML = `<span class="tc-metadata">${metaParts.join(' ‚Ä¢ ')}</span>`;
                }

                // New Biology-style card
                div.className = 'biology-test-card';

                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:18px; flex:1;">
                        <div style="width:44px;height:44px;background:rgba(63,114,175,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;">
                            üìÑ
                        </div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:700;font-size:1.07rem;color:var(--text-primary);margin-bottom:6px;">${f.name}</div>
                            
                            <div style="color:var(--text-secondary);font-size:0.88rem;line-height:1.4;">
                                ${f.questions ? `üìù ${f.questions} Qs` : ''} 
                                ${f.time ? ` ‚Ä¢ ‚è± ${f.time} min` : ''} 
                                ${f.marks ? ` ‚Ä¢ üéØ ${f.marks} marks` : ''}
                            </div>
                            
                            <div style="margin-top:8px;font-size:0.82rem;font-weight:600;color:#e74c3c;letter-spacing:0.4px;">
                                ‚óè ${statusText}
                            </div>
                        </div>
                    </div>
                    <button class="${btnClass}" style="padding:12px 34px;border-radius:50px;font-weight:700;font-size:0.93rem;white-space:nowrap;">${btnText}</button>
                `;

                div.onclick = function () {
                    if (savedResult) {
                        // Completed test - show result
                        location.href = "exam.html?showResult=true&file=" + encodeURIComponent(f.file);
                    } else if (savedProgress) {
                        // In-progress test - resume directly (skip instructions)
                        location.href = "exam.html?file=" + encodeURIComponent(f.file);
                    } else {
                        // New test - show instructions first
                        location.href = "instructions.html?file=" + encodeURIComponent(f.file);
                    }
                };
                list.appendChild(div);
            });

            // 4. Generate Dynamic Filters
            generateDynamicFilters();
        };

        // --- NEW DYNAMIC FILTER FUNCTION ---
        function generateDynamicFilters() {
            var container = document.getElementById('filter-options-list');
            container.innerHTML = '';

            // 1. Extract all unique tags from the loaded files
            var uniqueTags = new Set();
            loadedFiles.forEach(f => {
                if (f.tags) uniqueTags.add(f.tags);
            });

            // If no tags found, hide the filter button
            if (uniqueTags.size === 0) {
                document.getElementById('btn-filter-toggle').style.display = 'none';
                return;
            }

            // 2. Create Button for each Tag
            uniqueTags.forEach(tag => {
                var btn = document.createElement('div');
                btn.className = 'filter-option';
                btn.innerText = tag;
                btn.onclick = function () { applyFilter(tag, btn); };
                container.appendChild(btn);
            });
        }

        function toggleFilterMenu() {
            document.getElementById('filter-dropdown').classList.toggle('show');
        }

        function applyFilter(category, btnElement) {
            currentFilter = category.toLowerCase();

            // Update UI
            var allOpts = document.querySelectorAll('.filter-option');
            allOpts.forEach(el => el.classList.remove('selected'));
            if (btnElement) btnElement.classList.add('selected');
            document.getElementById('btn-filter-toggle').classList.add('active');

            // Filter Logic
            var items = document.querySelectorAll('.test-card-modern');
            var visibleCount = 0;

            items.forEach(function (item) {
                var itemTag = item.getAttribute('data-tag');
                // Check if the Item's tag matches the selected filter
                if (itemTag === currentFilter) {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            var msg = document.getElementById('no-result-msg');
            msg.style.display = (visibleCount === 0) ? 'block' : 'none';

            toggleFilterMenu();
        }

        function clearFilter() {
            currentFilter = null;
            var items = document.querySelectorAll('.test-card-modern');
            items.forEach(item => item.style.display = 'flex');

            var allOpts = document.querySelectorAll('.filter-option');
            allOpts.forEach(el => el.classList.remove('selected'));

            document.getElementById('btn-filter-toggle').classList.remove('active');
            document.getElementById('no-result-msg').style.display = 'none';
            toggleFilterMenu();
        }

        // Close menu on outside click
        window.onclick = function (event) {
            if (!event.target.matches('.btn-filter') && !event.target.closest('.filter-dropdown') && !event.target.closest('.btn-filter')) {
                var openDropdown = document.getElementById('filter-dropdown');
                if (openDropdown.classList.contains('show')) openDropdown.classList.remove('show');
            }
        }
        window.onpageshow = function (event) { if (event.persisted) window.location.reload(); };
    </script>
</body>

</html>
