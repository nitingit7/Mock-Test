<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Banking Mock Test (Fixed)</title>
    
    <!-- KaTeX for Math (Works if internet is on, otherwise shows code) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* CSS STYLES */
        :root { --blue: #007bff; --green: #28a745; --red: #dc3545; --dark: #343a40; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: sans-serif; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }

        .view { display: none; width: 100%; height: 100%; flex-direction: column; }
        .view.active { display: flex; }

        /* HOME */
        #view-home { align-items: center; padding: 20px; overflow-y: auto; }
        .subject-card { background: white; width: 100%; max-width: 500px; padding: 25px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-left: 5px solid transparent; }
        .subject-card:active { background-color: #e9ecef; }
        .icon { font-size: 24px; margin-right: 15px; }

        /* LIST */
        #view-list { align-items: center; padding: 20px; }
        .test-item { background: white; width: 100%; max-width: 500px; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }

        /* EXAM */
        header { height: 50px; background: var(--dark); color: white; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0; }
        .timer { font-family: monospace; font-size: 18px; font-weight: bold; background: #555; padding: 4px 8px; border-radius: 4px; }
        
        .exam-body { display: flex; flex: 1; overflow: hidden; position: relative; }
        .q-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; }
        .q-content { flex: 1; padding: 20px; overflow-y: auto; font-size: 1.1rem; line-height: 1.6; }
        .q-footer { padding: 10px; background: #f8f9fa; border-top: 1px solid #ddd; display: flex; justify-content: space-between; }

        .opt-row { display: flex; padding: 12px; border: 1px solid #ccc; margin-bottom: 10px; border-radius: 5px; cursor: pointer; align-items: center; }
        .opt-row.selected { background: #e3f2fd; border-color: var(--blue); border-width: 2px; }
        .opt-row.correct { background: #d4edda !important; border-color: var(--green) !important; }
        .opt-row.wrong { background: #f8d7da !important; border-color: var(--red) !important; }
        
        .solution-box { background: #fff3cd; padding: 15px; border: 1px solid #ffeeba; margin-top: 20px; border-radius: 5px; display: none; }

        #sidebar { position: absolute; right: 0; top: 0; bottom: 0; width: 280px; background: white; border-left: 1px solid #ccc; transform: translateX(100%); transition: 0.3s; z-index: 10; display: flex; flex-direction: column; }
        #sidebar.open { transform: translateX(0); box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 15px; overflow-y: auto; }
        .pal-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ccc; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 12px; }
        .p-ans { background: var(--green); color: white; border: none; }
        .p-not { background: var(--red); color: white; border: none; }
        .p-rev { background: #6f42c1; color: white; border: none; }

        #view-result { justify-content: center; align-items: center; background: white; }
        .score-card { text-align: center; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 10px; width: 90%; max-width: 400px; }

        .btn { padding: 10px 20px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; }
        .btn-green { background: var(--green); }
        .btn-red { background: var(--red); }
        .btn-blue { background: var(--blue); }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #333; }
        .back-btn { margin-bottom: 20px; cursor: pointer; color: var(--blue); font-weight: bold; display: block; }
        .katex { font-size: 1.1em; }
    </style>
</head>
<body>

    <!-- HOME -->
    <div id="view-home" class="view active">
        <h2 style="color: var(--dark); margin-bottom: 30px;">Banking Mock Tests</h2>
        <div class="subject-card" onclick="showList('quant')">
            <div style="display:flex; align-items:center;">
                <span class="icon">üìä</span> <div><strong>Quantitative Aptitude</strong></div>
            </div> <span>‚ûú</span>
        </div>
        <div class="subject-card" onclick="showList('reasoning')">
            <div style="display:flex; align-items:center;">
                <span class="icon">üß©</span> <div><strong>Reasoning Ability</strong></div>
            </div> <span>‚ûú</span>
        </div>
        <div class="subject-card" onclick="showList('english')">
            <div style="display:flex; align-items:center;">
                <span class="icon">üìñ</span> <div><strong>English Language</strong></div>
            </div> <span>‚ûú</span>
        </div>
    </div>

    <!-- LIST -->
    <div id="view-list" class="view">
        <div class="back-btn" onclick="switchView('view-home')">‚Üê Back</div>
        <h2 id="list-title">Select Test</h2>
        <div id="test-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
    </div>

    <!-- EXAM -->
    <div id="view-exam" class="view">
        <header>
            <div id="exam-title">Mock Test</div>
            <div class="timer" id="timer-display">00:00</div>
            <button class="btn-outline" style="background:white; padding: 2px 8px;" onclick="toggleSidebar()">‚ò∞</button>
        </header>
        <div class="exam-body">
            <main class="q-area">
                <div class="q-content">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <strong style="color:var(--blue);" id="q-number">Q1</strong>
                        <span style="font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px;">Marks: +1 / -0.25</span>
                    </div>
                    <div id="q-text" style="margin-bottom:20px;">Loading...</div>
                    <div id="options-box"></div>
                    <div id="solution-box" class="solution-box">
                        <strong>Solution:</strong> <div id="sol-text"></div>
                    </div>
                </div>
                <div class="q-footer" id="exam-footer">
                    <button class="btn btn-red" onclick="clearResponse()">Clear</button>
                    <button class="btn" style="background:#6f42c1;" onclick="markReview()">Review</button>
                    <button class="btn btn-green" onclick="saveNext()">Save & Next</button>
                </div>
                <div class="q-footer" id="review-footer" style="display:none;">
                    <button class="btn btn-outline" onclick="prevQ()">Prev</button>
                    <button class="btn btn-blue" onclick="nextQ()">Next</button>
                    <button class="btn btn-red" onclick="exitReview()">Exit</button>
                </div>
            </main>
            <aside id="sidebar">
                <div style="padding:10px; font-weight:bold; border-bottom:1px solid #eee;">
                    Palette <span style="float:right; cursor:pointer;" onclick="toggleSidebar()">‚úñ</span>
                </div>
                <div class="palette-grid" id="palette-grid"></div>
                <div style="margin-top:auto; padding:15px;">
                    <button class="btn btn-green" style="width:100%;" onclick="submitTest(false)">SUBMIT TEST</button>
                </div>
            </aside>
        </div>
    </div>

    <!-- RESULT -->
    <div id="view-result" class="view">
        <div class="score-card">
            <h2>Test Result</h2>
            <div style="font-size:3rem; font-weight:bold; color:var(--blue);" id="final-score">0</div>
            <p>Total Marks</p>
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <span style="color:green;">Correct: <b id="final-correct">0</b></span>
                <span style="color:red;">Wrong: <b id="final-wrong">0</b></span>
                <span>Unatt: <b id="final-unatt">0</b></span>
            </div>
            <button class="btn btn-blue" style="width:100%; margin-bottom:10px;" onclick="startReviewMode()">Review Solutions</button>
            <button class="btn btn-outline" style="width:100%;" onclick="location.reload()">Back to Home</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        var DB = {
            'quant': [
                {
                    title: "Quant Speed Test",
                    timeLimit: 20,
                    questions: [
                        { text: "Solve: $$\\sqrt{144} + 12^{2}$$", options: ["146", "156", "134", "166", "144"], correctIndex: 1, solution: "12 + 144 = 156" },
                        { text: "Value of x: $$3x + 5 = 20$$", options: ["3", "4", "5", "6", "7"], correctIndex: 2, solution: "3x = 15, so x = 5" },
                        { text: "20% of 500?", options: ["80", "90", "100", "110", "120"], correctIndex: 2, solution: "500 * 0.20 = 100" }
                    ]
                }
            ],
            'reasoning': [
                {
                    title: "Puzzles",
                    timeLimit: 20,
                    questions: [
                        { text: "Find odd one out: Car, Bus, Train, Apple", options: ["Car", "Bus", "Apple", "Train"], correctIndex: 2, solution: "Apple is a fruit." },
                        { text: "A is father of B. B is sister of C. How is A related to C?", options: ["Father", "Uncle", "Brother", "Grandfather"], correctIndex: 0, solution: "A is the father." }
                    ]
                }
            ],
            'english': [
                {
                    title: "Grammar",
                    timeLimit: 15,
                    questions: [
                        { text: "Synonym of 'HAPPY'", options: ["Sad", "Joyful", "Angry", "Tired"], correctIndex: 1, solution: "Joyful means happy." }
                    ]
                }
            ]
        };

        // --- GLOBAL VARIABLES (No 'app' object) ---
        var currentData = null;
        var responses = {};
        var currentQ = 0;
        var timerInterval = null;
        var timeLeft = 0;
        var isReview = false;

        // --- FUNCTIONS ---

        function switchView(id) {
            var views = document.querySelectorAll('.view');
            for(var i=0; i<views.length; i++) { views[i].classList.remove('active'); }
            document.getElementById(id).classList.add('active');
        }

        function showList(subj) {
            var list = document.getElementById('test-container');
            list.innerHTML = '';
            document.getElementById('list-title').innerText = subj.toUpperCase();
            
            var tests = DB[subj];
            
            // Loop through tests
            for (var i = 0; i < tests.length; i++) {
                (function(idx) {
                    var t = tests[idx];
                    var div = document.createElement('div');
                    div.className = 'test-item';
                    
                    var btn = document.createElement('button');
                    btn.className = 'btn btn-green';
                    btn.innerText = "Start";
                    btn.onclick = function() { startExam(subj, idx); };

                    var span = document.createElement('span');
                    span.innerText = t.title;

                    div.appendChild(span);
                    div.appendChild(btn);
                    list.appendChild(div);
                })(i);
            }
            switchView('view-list');
        }

        function startExam(subj, idx) {
            currentData = DB[subj][idx];
            responses = {};
            currentQ = 0;
            isReview = false;
            
            for(var i=0; i<currentData.questions.length; i++) {
                responses[i] = { sel: null, status: 'not-visited' };
            }
            
            timeLeft = currentData.timeLimit * 60;
            startTimer();
            
            document.getElementById('exam-title').innerText = currentData.title;
            document.getElementById('exam-footer').style.display = 'flex';
            document.getElementById('review-footer').style.display = 'none';
            
            switchView('view-exam');
            loadQ();
        }

        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            var disp = document.getElementById('timer-display');
            
            timerInterval = setInterval(function() {
                if(timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitTest(true);
                    return;
                }
                timeLeft--;
                var m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
                var s = (timeLeft % 60).toString().padStart(2,'0');
                disp.innerText = m + ":" + s;
            }, 1000);
        }

        function loadQ() {
            var q = currentData.questions[currentQ];
            var r = responses[currentQ];
            
            if(!isReview && r.status === 'not-visited') r.status = 'not-answered';
            
            document.getElementById('q-number').innerText = "Q" + (currentQ + 1);
            document.getElementById('q-text').innerText = q.text;
            
            var box = document.getElementById('options-box');
            box.innerHTML = '';
            
            q.options.forEach(function(opt, i) {
                var row = document.createElement('div');
                row.className = 'opt-row';
                if(isReview) {
                    row.style.pointerEvents = 'none';
                    if(i === q.correctIndex) row.classList.add('correct');
                    if(r.sel === i && i !== q.correctIndex) row.classList.add('wrong');
                } else {
                    if(r.sel === i) row.classList.add('selected');
                    row.onclick = function() {
                        r.sel = i;
                        loadQ(); // Re-render
                    };
                }
                row.innerHTML = "<b>" + ['A','B','C','D','E'][i] + "</b> &nbsp; " + opt;
                box.appendChild(row);
            });

            var solBox = document.getElementById('solution-box');
            if(isReview) {
                solBox.style.display = 'block';
                document.getElementById('sol-text').innerText = q.solution;
            } else {
                solBox.style.display = 'none';
            }

            renderPalette();
            
            // Render Math
            if(window.renderMathInElement) {
                renderMathInElement(document.getElementById('q-text'));
                renderMathInElement(document.getElementById('options-box'));
                renderMathInElement(document.getElementById('sol-text'));
            }
        }

        function saveNext() {
            var r = responses[currentQ];
            if(r.sel !== null) r.status = 'ans';
            else r.status = 'not-answered';
            if(currentQ < currentData.questions.length - 1) { currentQ++; loadQ(); }
        }

        function markReview() {
            var r = responses[currentQ];
            if(r.sel !== null) r.status = 'ans-rev';
            else r.status = 'rev';
            if(currentQ < currentData.questions.length - 1) { currentQ++; loadQ(); }
        }

        function clearResponse() {
            responses[currentQ].sel = null;
            responses[currentQ].status = 'not-answered';
            loadQ();
        }

        function prevQ() { if(currentQ > 0) { currentQ--; loadQ(); } }
        function nextQ() { if(currentQ < currentData.questions.length - 1) { currentQ++; loadQ(); } }

        function renderPalette() {
            var grid = document.getElementById('palette-grid');
            grid.innerHTML = '';
            
            for(var i=0; i<currentData.questions.length; i++) {
                (function(idx){
                    var btn = document.createElement('div');
                    btn.className = 'pal-btn';
                    btn.innerText = idx + 1;
                    var s = responses[idx].status;
                    
                    if(isReview) {
                        var r = responses[idx];
                        if(r.sel === currentData.questions[idx].correctIndex) btn.style.background = '#28a745';
                        else if(r.sel !== null) btn.style.background = '#dc3545';
                        else btn.style.background = '#ccc';
                        btn.style.color = 'white';
                    } else {
                        if(s === 'ans' || s === 'ans-rev') btn.classList.add('p-ans');
                        else if(s === 'not-answered') btn.classList.add('p-not');
                        else if(s === 'rev') btn.classList.add('p-rev');
                    }
                    if(idx === currentQ) btn.style.border = '2px solid black';
                    btn.onclick = function() { currentQ = idx; loadQ(); };
                    grid.appendChild(btn);
                })(i);
            }
        }

        function toggleSidebar() { 
            var sb = document.getElementById('sidebar');
            if(sb.classList.contains('open')) sb.classList.remove('open');
            else sb.classList.add('open');
        }
        
        function submitTest(force) {
            if(!force && !confirm("Submit Test?")) return;
            clearInterval(timerInterval);
            
            var score = 0, corr = 0, wrong = 0, unatt = 0;
            
            currentData.questions.forEach(function(q, i) {
                var r = responses[i];
                if(r.sel !== null) {
                    if(r.sel === q.correctIndex) { score += 1; corr++; }
                    else { score -= 0.25; wrong++; }
                } else unatt++;
            });

            document.getElementById('final-score').innerText = score.toFixed(2);
            document.getElementById('final-correct').innerText = corr;
            document.getElementById('final-wrong').innerText = wrong;
            document.getElementById('final-unatt').innerText = unatt;
            switchView('view-result');
        }

        function startReviewMode() {
            isReview = true;
            currentQ = 0;
            document.getElementById('exam-footer').style.display = 'none';
            document.getElementById('review-footer').style.display = 'flex';
            switchView('view-exam');
            loadQ();
        }

        function exitReview() { switchView('view-result'); }
        
        // Attach global functions to window explicitly for extra safety
        window.showList = showList;
        window.startExam = startExam;
        window.switchView = switchView;
        window.loadQ = loadQ;
        window.saveNext = saveNext;
        window.markReview = markReview;
        window.clearResponse = clearResponse;
        window.prevQ = prevQ;
        window.nextQ = nextQ;
        window.toggleSidebar = toggleSidebar;
        window.submitTest = submitTest;
        window.startReviewMode = startReviewMode;
        window.exitReview = exitReview;

    </script>
</body>
</html>